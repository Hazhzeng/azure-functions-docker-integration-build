parameters:
  proxyAntaresCmdAddress: ''
  proxyUsername: ''
  proxyPassword: ''
  artifactPythonVersion: 'python36'
  artifactImageName: 'mesh'
  minContainers: '2'
  maxContainers: '4'
  placeholderId: 'v=1,k=f,e=~2,a=0'
  skipImageUpdate: 'false'

steps:
- task: InstallSSHKey@0
  inputs:
    knownHostsEntry: $(knownHostsEntry)
    sshPublicKey: $(sshPublicKey)
    sshPassphrase: $(sshPassphrase)
    sshKeySecureFile: id_rsa
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.7'
    addToPath: true
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
- script: |
    python -m pip install requests
  displayName: Install Python Prerequisites
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
- bash: |
    git clone --single-branch --branch master --depth 1 git@github.com:maiqbal11/azure-functions-docker.git
    git clone --single-branch --branch master --depth 1 git@github.com:maiqbal11/azure-functions-docker-private.git
  displayName: Clone Required Repos
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
- bash: |
    docker build -t local/azure-functions-base:$PYTHONVERSION-test-2.0 -f azure-functions-docker/host/2.0/stretch/amd64/base.Dockerfile --build-arg HOST_VERSION="test-2.0.0" azure-functions-docker/host
    docker build -t local/azure-functions-python-deps:$PYTHONVERSION-test-2.0 -f azure-functions-docker/host/2.0/stretch/amd64/python/$PYTHONVERSION-deps.Dockerfile azure-functions-docker/host
    docker build -t local/azure-functions-python:$PYTHONVERSION-test-2.0 -f azure-functions-docker/host/2.0/stretch/amd64/python/$PYTHONVERSION.Dockerfile --build-arg BASE_IMAGE="local/azure-functions-base:$PYTHONVERSION-test-2.0" --build-arg BASE_PYTHON_IMAGE="local/azure-functions-python-deps:$PYTHONVERSION-test-2.0" azure-functions-docker/host
    docker build -t local/azure-functions-mesh:$PYTHONVERSION-test-2.0 -f azure-functions-docker-private/host/2.0/stretch/amd64/$IMAGENAME.Dockerfile --build-arg BASE_IMAGE="local/azure-functions-python:$PYTHONVERSION-test-2.0" --build-arg HOST_VERSION="test-2.0.0" azure-functions-docker-private/host
    docker tag local/azure-functions-mesh:$PYTHONVERSION-test-2.0 maheeri/$PYTHONVERSION-test-2.0:$TAGNUMBER
  env:
    TAGNUMBER: $(Build.BuildNumber)
    PYTHONVERSION: ${{ parameters.artifactPythonVersion }}
    IMAGENAME: ${{ parameters.artifactImageName }}
  displayName: Build Docker Image
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
- task: Docker@2
  displayName: Login to Docker Hub
  inputs:
    command: login
    containerRegistry: myDockerHub
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
- task: Docker@2
  displayName: Push to Docker Hub
  inputs:
    command: push
    repository: maheeri/${{ parameters.artifactPythonVersion }}-test-2.0
    tags: |
      $(Build.BuildNumber)
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
- task: PythonScript@0
  displayName: Update Mesh Image
  inputs:
    scriptSource: filePath
    scriptPath: proxy_operations/update_mesh_image.py
    arguments: --image-name maheeri/${{ parameters.artifactPythonVersion }}-test-2.0:$(Build.BuildNumber) --proxy-address $(proxyAntaresCmdAddress) --proxy-username $(proxyUsername) --proxy-password $(proxyPassword) --placeholder-id ${{ parameters.placeholderId }} --min-containers ${{ parameters.minContainers }} --max-containers ${{ parameters.maxContainers }} --hostname-type Standard
  condition: ne('${{ parameters.skipImageUpdate }}', 'true')
